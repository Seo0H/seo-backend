name: Docker CD Pipeline

on:
  workflow_run:
    workflows: ["Docker Image CI"]
    types:
        - completed

jobs:

  build:
    runs-on: self-hosted
    steps:
      - name : ğŸ“ Make Env & ssl File
        run: |
          echo "make env folder"

          if [ ! -d "env" ]; then
          mkdir -p env
              echo "í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: env"
          else
              echo "í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: env"
          fi

          if [ ! -d "ssl" ]; then
          mkdir -p ssl
              echo "í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ssl"
          else
              echo "í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ssl"
          fi

          echo "${{ secrets.ENV_LOCAL }}" > env/.env.local
          echo "${{ secrets.DB_SSL }}" > ssl/prod-ca-2021.crt

      - name: â¬ Pull Docker image
        run: sudo docker pull seoh99/seo-backend:latest

      - name: ğŸ—‘ï¸ Delete Old docker container
        run: sudo docker rm -f seo-backend || true

      - name: ğŸ‘Ÿ Run Docker Container
        run: sudo docker run -d -p 80:8080 --env-file env/.env.local --name seo-backend seoh99/seo-backend
